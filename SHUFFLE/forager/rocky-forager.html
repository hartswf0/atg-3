<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Rocky Forager</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22%237aa2f7%22><path d=%22M19.6 10c0-3.3-2.7-6-6-6-2.5 0-4.7 1.5-5.6 3.8C7.6 7.9 7.3 7.9 7 7.9c-2.8 0-5 2.2-5 5s2.2 5 5 5h12.6c2.4 0 4.4-2 4.4-4.4 0-2.1-1.5-3.9-3.4-4.3z%22/></svg>">
    <style>
        :root {
            --bg: #0a0a0f;
            --surface: #12121a;
            --panel: #1a1a24;
            --border: #2a2a3a;
            --text-main: #e8e8f0;
            --text-dim: #9999aa;
            --text-muted: #666677;

            --func: #ff6b9d;
            --link: #7aa2f7;
            --hot: #ffffff;
            --up: #9ece6a;
            --citation: #e0af68;
            --tray: #f7768e;
            --note: #9ece6a;
            --h1: #bb9af7;
            --h2: #7aa2f7;
            --h3: #73daca;
            --para: #3a3a4a;

            --font-mono: 'JetBrains Mono', 'SF Mono', monospace;
            --font-sans: 'Inter', -apple-system, sans-serif;
            --radius: 4px;
            --tray-height: 340px;
        }

        [data-theme="light"] {
            --bg: #fafafa;
            --surface: #ffffff;
            --panel: #f0f0f5;
            --border: #d0d0dd;
            --text-main: #1a1a2e;
            --text-dim: #444455;
            --text-muted: #666677;
            --hot: #1a1a2e;
            /* Better contrast for headings in light mode */
            --h1: #7c3aed;
            --h2: #2563eb;
            --h3: #059669;
            --citation: #b45309;
            --note: #16a34a;
            --tray: #dc2626;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
        }

        body {
            background: var(--bg);
            color: var(--text-main);
            font-family: var(--font-sans);
            display: flex;
            flex-direction: column;
        }

        /* Styled Scrollbars — Minimal */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        * {
            scrollbar-width: thin;
            scrollbar-color: var(--border) transparent;
        }

        /* Header — Grandma Friendly */
        header {
            height: 48px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 12px;
            flex-shrink: 0;
        }

        .brand {
            font-weight: 700;
            font-size: 13px;
            letter-spacing: 0.05em;
            color: var(--text-dim);
            font-family: var(--font-mono);
        }

        .brand b {
            color: var(--func);
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn {
            background: var(--panel);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 4px 12px;
            font-family: var(--font-mono);
            font-size: 11px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-icon {
            padding: 10px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }

        .btn-icon svg {
            display: block;
        }

        .btn.primary {
            background: var(--primary);
            color: var(--bg);
            border: none;
        }

        button.btn.primary {
            border-color: var(--up);
            color: var(--up);
        }

        button.btn.tray-btn {
            border-color: var(--tray);
            color: var(--tray);
        }

        .settings-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: var(--panel);
            border: 1px solid var(--border);
            cursor: pointer;
            font-family: var(--font-mono);
            color: var(--text-dim);
        }

        .settings-dropdown {
            position: absolute;
            top: 56px;
            right: 0;
            width: 280px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            display: none;
            z-index: 300;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .settings-dropdown.open {
            display: block;
        }

        .settings-section {
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border);
        }

        .settings-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .settings-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 8px;
            font-family: var(--font-mono);
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            font-size: 12px;
            min-height: 44px;
        }

        .toggle-switch {
            width: 24px;
            height: 12px;
            background: var(--border);
            border-radius: 6px;
            position: relative;
            cursor: pointer;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: left 0.15s;
        }

        .toggle-switch.on {
            background: var(--up);
        }

        .toggle-switch.on::after {
            left: 14px;
        }

        .settings-slider {
            width: 80px;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--border);
            border-radius: 2px;
            cursor: pointer;
        }

        .settings-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 10px;
            height: 10px;
            background: var(--link);
            border-radius: 50%;
            cursor: pointer;
        }

        .settings-select {
            background: var(--panel);
            border: 1px solid var(--border);
            color: var(--text-main);
            font-size: 7px;
            padding: 2px 4px;
            border-radius: 3px;
            width: 100%;
        }

        .tts-controls {
            display: flex;
            gap: 4px;
            margin-top: 4px;
        }

        .tts-btn {
            flex: 1;
            padding: 4px;
            font-size: 8px;
            cursor: pointer;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 3px;
            color: var(--text-main);
            text-align: center;
        }

        .tts-btn:hover {
            border-color: var(--link);
        }

        .tts-btn.playing {
            background: var(--link);
            color: var(--bg);
        }

        /* Styled Quotes */
        .md-quote {
            border-left: 2px solid var(--link);
            padding-left: 8px;
            margin: 4px 0;
            color: var(--text-dim);
            font-style: italic;
        }

        /* Main */
        .main-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Grid Panel */
        .grid-panel {
            width: 40%;
            min-width: 180px;
            max-width: 55%;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex-shrink: 0;
        }

        .grid-nav {
            display: flex;
            border-bottom: 1px solid var(--border);
            background: var(--surface);
            flex-shrink: 0;
        }

        .grid-tab {
            flex: 1;
            padding: 5px;
            font-size: 8px;
            font-family: var(--font-mono);
            text-align: center;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: var(--text-muted);
        }

        .grid-tab:hover {
            color: var(--text-main);
        }

        .grid-tab.active {
            color: var(--link);
            border-bottom-color: var(--link);
        }

        .grid-tab.tray-tab {
            color: var(--tray);
        }

        .grid-tab.tray-tab.active {
            border-bottom-color: var(--tray);
        }

        .grid-header {
            padding: 4px 8px;
            font-size: 7px;
            font-family: var(--font-mono);
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
            background: var(--panel);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .grid-content {
            flex: 1;
            overflow-y: auto;
            padding: 4px;
        }

        .idea-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(72px, 1fr));
            gap: 4px;
        }

        /* BRICK — Full Color Background, Symbol in Corner */
        .brick {
            aspect-ratio: 1/1;
            border-radius: var(--radius);
            padding: 5px;
            cursor: pointer;
            transition: all 0.1s;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            border: 1px solid transparent;
        }

        .brick.h1 {
            background: rgba(187, 154, 247, 0.15);
            border-color: rgba(187, 154, 247, 0.3);
        }

        .brick.h2 {
            background: rgba(122, 162, 247, 0.15);
            border-color: rgba(122, 162, 247, 0.3);
        }

        .brick.h3 {
            background: rgba(115, 218, 202, 0.15);
            border-color: rgba(115, 218, 202, 0.3);
        }

        .brick.cite {
            background: rgba(224, 175, 104, 0.15);
            border-color: rgba(224, 175, 104, 0.3);
        }

        .brick.doc {
            background: rgba(122, 162, 247, 0.12);
            border-color: rgba(122, 162, 247, 0.25);
        }

        .brick:hover {
            transform: scale(1.04);
            z-index: 20;
            border-color: var(--hot);
        }

        .brick.active {
            border-color: var(--link);
            box-shadow: 0 0 0 2px rgba(122, 162, 247, 0.4);
        }

        .brick.current {
            border-color: var(--hot);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
        }

        .brick.in-tray {
            border-color: var(--tray);
            box-shadow: inset 0 0 0 2px rgba(247, 118, 142, 0.3);
        }

        .brick.has-note::before {
            content: '✎';
            position: absolute;
            top: 3px;
            left: 3px;
            font-size: 8px;
            color: var(--note);
        }

        .brick-title {
            font-size: 8px;
            font-weight: 500;
            line-height: 1.2;
            flex: 1;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 5;
            line-clamp: 5;
            -webkit-box-orient: vertical;
        }

        .brick-symbol {
            position: absolute;
            bottom: 3px;
            right: 3px;
            font-size: 7px;
            font-weight: 700;
            font-family: var(--font-mono);
            opacity: 0.6;
        }

        .brick.h1 .brick-symbol {
            color: var(--h1);
        }

        .brick.h2 .brick-symbol {
            color: var(--h2);
        }

        .brick.h3 .brick-symbol {
            color: var(--h3);
        }

        .brick.cite .brick-symbol {
            color: var(--citation);
        }

        .brick.doc .brick-symbol {
            color: var(--link);
        }

        /* Hover Tooltip — Reveals More Text */
        .brick-tooltip {
            position: fixed;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 8px;
            max-width: 280px;
            font-size: 10px;
            line-height: 1.4;
            z-index: 1000;
            pointer-events: none;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .brick-tooltip.visible {
            display: block;
        }

        .resizer {
            width: 4px;
            background: var(--border);
            cursor: col-resize;
            flex-shrink: 0;
        }

        .resizer:hover {
            background: var(--link);
        }

        /* Text Panel */
        .text-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--surface);
            min-width: 240px;
        }

        .text-header {
            padding: 4px 8px;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .file-path {
            font-size: 7px;
            font-family: var(--font-mono);
            color: var(--text-muted);
        }

        .text-title {
            font-size: 9px;
            font-weight: 700;
        }

        .text-body {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .text-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            font-size: 11px;
            line-height: 1.5;
        }

        .line {
            display: flex;
            align-items: baseline;
            padding: 2px 4px;
            border-left: 2px solid transparent;
            cursor: pointer;
        }

        .line:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .line.current {
            background: rgba(122, 162, 247, 0.1);
        }

        .line.in-tray {
            border-left-color: var(--accent);
            background: rgba(255, 158, 100, 0.15);
        }

        .ln {
            width: 24px;
            color: var(--text-muted);
            font-size: 9px;
            text-align: right;
            margin-right: 8px;
            user-select: none;
        }

        .minimap {
            width: 20px;
            background: var(--bg);
            border-left: 1px solid var(--border);
            position: relative;
            flex-shrink: 0;
        }

        .minimap canvas {
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }

        .minimap-viewport {
            position: absolute;
            left: 0;
            width: 100%;
            border: 1px solid var(--primary);
            background: rgba(122, 162, 247, 0.1);
            pointer-events: none;
            transition: top 0.1s;
        }

        /* Selection Popup */
        .selection-popup {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: var(--primary);
            color: var(--bg);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 500;
            animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Add Brick */
        .add-doc-brick {
            border-style: dashed !important;
            border-color: var(--secondary) !important;
            background: rgba(187, 154, 247, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-doc-brick:hover {
            background: rgba(187, 154, 247, 0.1);
        }

        /* Document Toolbar & Bulk Actions */
        .doc-toolbar {
            display: none;
        }

        /* Deprecated */

        .bulk-actions {
            position: fixed;
            top: 80px;
            /* Moved to top */
            left: 50%;
            transform: translateX(-50%) translateY(-150px);
            opacity: 0;
            pointer-events: none;
            background: var(--panel);
            border: 1px solid var(--border);
            padding: 8px 16px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1000;
        }

        .bulk-actions.visible {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
            pointer-events: auto;
        }

        .brick.doc.selected {
            border-color: var(--secondary);
            background: rgba(187, 154, 247, 0.1);
        }

        .brick.doc.selected::after {
            content: '✓';
            position: absolute;
            top: 4px;
            right: 4px;
            width: 16px;
            height: 16px;
            background: var(--secondary);
            color: var(--bg);
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(2px);
        }

        .modal-overlay.open {
            display: flex;
        }

        .modal {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 20px;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .btn-sm {
            padding: 2px 8px;
            font-size: 10px;
            height: 24px;
        }

        .line {
            display: flex;
            padding: 2px 4px;
            cursor: pointer;
            border-left: 2px solid transparent;
            border-radius: 0 var(--radius) var(--radius) 0;
            margin-bottom: 1px;
            transition: all 0.08s;
        }

        .line:hover {
            background: var(--panel);
        }

        .line.highlight {
            background: rgba(122, 162, 247, 0.2);
            border-left-color: var(--link);
        }

        .line.in-tray {
            background: rgba(247, 118, 142, 0.08);
            border-left-color: var(--tray);
        }

        .line.h1 {
            font-size: 13px;
            font-weight: 800;
            margin-top: 14px;
            margin-bottom: 3px;
            color: var(--h1);
        }

        .line.h2 {
            font-size: 10px;
            font-weight: 700;
            margin-top: 8px;
            margin-bottom: 2px;
            color: var(--h2);
        }

        .line.h3 {
            font-size: 9px;
            font-weight: 700;
            margin-top: 5px;
            color: var(--h3);
        }

        .line.tts-active {
            background: rgba(122, 162, 247, 0.35);
            border-left-color: var(--link);
            border-left-width: 4px;
            animation: tts-pulse 0.5s ease-in-out;
        }

        @keyframes tts-pulse {
            0% {
                background: rgba(122, 162, 247, 0.5);
            }

            100% {
                background: rgba(122, 162, 247, 0.35);
            }
        }

        .line.has-note::after {
            content: '✎';
            margin-left: 6px;
            color: var(--note);
            font-size: 9px;
        }

        .ln {
            width: 22px;
            text-align: right;
            margin-right: 4px;
            font-size: 7px;
            font-family: var(--font-mono);
            color: var(--text-muted);
            opacity: 0.35;
            user-select: none;
            flex-shrink: 0;
        }

        .line-text {
            flex: 1;
            word-wrap: break-word;
        }

        .cite-ref {
            background: rgba(224, 175, 104, 0.1);
            color: var(--citation);
            padding: 0 2px;
            border-radius: 2px;
            font-family: var(--font-mono);
            font-size: 0.9em;
        }

        .md-bold {
            font-weight: 700;
        }

        /* =================================================
           TRAY — With Sticky Notes
           ================================================= */
        .tray-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--tray-height);
            background: var(--surface);
            border-top: 1px solid var(--border);
            z-index: 400;
            display: flex;
            flex-direction: column;
            transform: translateY(calc(100% - 28px));
            transition: transform 0.2s ease;
        }

        .tray-container.open {
            transform: translateY(0);
        }

        .tray-resize {
            height: 4px;
            background: var(--border);
            cursor: ns-resize;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tray-resize:hover {
            background: var(--link);
        }

        .tray-resize::after {
            content: '';
            width: 30px;
            height: 2px;
            background: var(--text-muted);
            border-radius: 1px;
        }

        .tray-bar {
            display: flex;
            align-items: center;
            padding: 5px 8px;
            gap: 6px;
            cursor: pointer;
            flex-shrink: 0;
            background: var(--panel);
            border-bottom: 1px solid var(--border);
        }

        .tray-bar:hover {
            background: var(--surface);
        }

        .tray-bar-title {
            font-size: 8px;
            font-weight: 700;
            font-family: var(--font-mono);
            color: var(--tray);
        }

        .tray-bar-count {
            font-size: 11px;
            font-weight: 800;
            color: var(--tray);
        }

        .tray-bar-preview {
            flex: 1;
            font-size: 7px;
            color: var(--text-muted);
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .tray-content {
            flex: 1;
            overflow-y: auto;
            padding: 6px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .tray-item {
            background: rgba(41, 46, 66, 0.4);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 8px;
            /* Compact padding */
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            /* Flexrow for Side-by-Side */
            flex-direction: row;
            gap: 12px;
            align-items: flex-start;
        }

        /* Note Column (The "Square Grid") */
        .tray-item-note-column {
            flex: 0 0 120px;
            /* Fixed width note column */
            display: flex;
            flex-direction: column;
            gap: 4px;
            border-right: 1px dashed var(--border);
            padding-right: 8px;
            min-height: 100%;
        }

        .tray-item-note-inline {
            background: rgba(255, 236, 179, 0.15);
            border: 1px solid rgba(255, 236, 179, 0.4);
            color: #ffe082;
            font-size: 12px;
            padding: 8px;
            border-radius: 4px;
            min-height: 50px;
            /* Square-ish */
            font-family: var(--font-mono);
            white-space: pre-wrap;
            outline: none;
            transition: all 0.2s;
        }

        .tray-item-note-inline:focus {
            background: rgba(255, 236, 179, 0.25);
            border-color: #ffecb3;
            box-shadow: 0 0 5px rgba(255, 236, 179, 0.2);
        }

        .tray-item-note-inline:empty::before {
            content: '+ Note';
            opacity: 0.7;
            font-style: italic;
            color: rgba(255, 236, 179, 0.6);
        }

        /* Content Column */
        .tray-item-content-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .tray-item:hover {
            background: var(--bg-main);
        }

        .tray-item.selected {
            background: var(--bg-main);
            border-left: 4px solid var(--primary);
            padding-left: 4px;
            /* Adjust for border */
        }

        .tray-item-body {
            font-size: 14px;
            /* Larger */
            font-family: var(--font-main);
            /* Match Editor */
            color: var(--text-main);
            line-height: 1.6;
            outline: none;
        }

        /* Drag Handle */
        .tray-drag-handle {
            position: absolute;
            top: 50%;
            right: 8px;
            transform: translateY(-50%);
            opacity: 0;
            cursor: grab;
            color: var(--text-muted);
            padding: 4px;
        }

        .tray-item:hover .tray-drag-handle {
            opacity: 0.5;
        }

        .tray-item:hover .tray-drag-handle:hover {
            opacity: 1;
            color: var(--primary);
        }

        .tray-item-meta {
            display: flex;
            align-items: center;
            font-size: 0.8em;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .tray-item-num {
            font-weight: bold;
            color: var(--primary);
            margin-right: 8px;
            font-family: monospace;
        }

        .tray-item-note-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            color: var(--primary);
            display: none;
        }

        .tray-item.has-note .tray-item-note-indicator {
            display: block;
        }

        /* Footer Actions */
        .tray-footer .btn {
            padding: 4px 8px;
            font-size: 0.9em;
            min-width: unset;
        }

        .tray-footer #btn-note.active {
            background: var(--primary);
            color: white;
        }

        /* WCAG Accessible Control Buttons — Horizontal Bar, 36px tall */
        .tray-item-btn {
            flex: 1;
            height: 28px;
            border-radius: 4px;
            border: 1px solid var(--border);
            background: var(--panel);
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-dim);
            transition: all 0.1s;
        }

        .tray-item-btn:hover {
            border-color: var(--link);
            color: var(--hot);
            background: var(--surface);
        }

        .tray-item-btn:focus {
            outline: 2px solid var(--link);
            outline-offset: 1px;
        }

        .tray-item-btn.delete:hover {
            border-color: var(--tray);
            color: var(--tray);
        }

        .tray-item-btn.note-btn:hover {
            border-color: var(--note);
            color: var(--note);
        }

        .tray-item-btn.note-btn {
            color: var(--note);
            border-color: var(--note);
        }

        .tray-item-btn.note-btn:hover {
            background: var(--note);
            color: var(--bg);
        }

        .tray-item-btn.delete:hover {
            border-color: var(--tray);
            color: var(--tray);
        }

        .tray-item-body {
            padding: 8px;
            font-size: 10px;
            line-height: 1.45;
            min-height: 40px;
            outline: none;
            border-left: 3px solid var(--tray);
        }

        .tray-item-body:focus {
            background: rgba(247, 118, 142, 0.05);
        }

        .tray-item-provenance {
            padding: 3px 6px;
            font-size: 6px;
            font-family: var(--font-mono);
            color: var(--text-muted);
            background: var(--bg);
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
        }

        .tray-item-citation {
            padding: 4px 6px;
            font-size: 8px;
            color: var(--citation);
            background: rgba(224, 175, 104, 0.05);
            border-top: 1px solid var(--border);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tray-item-citation.expanded {
            white-space: normal;
        }

        .cite-num {
            font-weight: bold;
            color: var(--secondary);
            margin-right: 4px;
        }

        .cite-body {
            color: var(--text-muted);
        }

        /* Note Margin — Sticky Note */
        .tray-item-note {
            width: 120px;
            background: rgba(158, 206, 106, 0.08);
            border-left: 1px solid var(--note);
            padding: 6px;
            font-size: 9px;
            line-height: 1.35;
            display: none;
            flex-direction: column;
        }

        .tray-item-note.visible {
            display: flex;
        }

        .tray-item-note-label {
            font-size: 6px;
            font-family: var(--font-mono);
            color: var(--note);
            margin-bottom: 3px;
            font-weight: 700;
        }

        .tray-item-note-text {
            flex: 1;
            outline: none;
            color: var(--note);
        }

        .tray-item-note-text:empty::before {
            content: 'Add note...';
            color: var(--text-muted);
        }

        .tray-footer {
            padding: 8px 12px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
            flex-shrink: 0;
            background: var(--panel);
        }

        .tray-footer button {
            flex: 1;
            font-size: 11px;
            padding: 8px 12px;
        }

        .tray-empty {
            padding: 24px;
            text-align: center;
            color: var(--text-muted);
            font-size: 12px;
        }

        @media (max-width: 700px) {
            .main-container {
                flex-direction: column;
            }

            .grid-panel {
                width: 100% !important;
                max-width: 100%;
                height: 32vh;
            }

            .resizer {
                display: none;
            }

            @media (max-width: 600px) {
                .brand {
                    display: none !important;
                }

                /* Hide Title on Mobile */
                .header-controls {
                    justify-content: space-between;
                    width: 100%;
                }

                .resizer {
                    width: 14px;
                    opacity: 0.8 !important;
                    background: var(--border);
                }

                /* Bigger Touch Target */
                #tts-controls-wrapper {
                    display: none;
                }

                /* Hide TTS on mobile to save space */
                #fullscreen-btn {
                    display: inline-flex !important;
                }
            }
    </style>
</head>

<body>
    <header>
        <div class="brand">ROCKY FORAGER <b>//</b> TRANSCLUSION</div>
        <div class="header-controls">
            <button class="btn tray-btn" onclick="toggleTray()">TRAY <span id="tray-badge">0</span></button>
            <!-- TTS Controls in Header -->
            <div id="tts-controls-wrapper"
                style="display:flex;align-items:center;gap:3px;border:1px solid var(--border);border-radius:4px;padding:2px 4px;">
                <button class="btn" id="tts-play-header" onclick="toggleTTS()" style="padding:2px 6px;">▶</button>
                <button class="btn" id="tts-catchup" onclick="ttsCatchUp()" style="padding:2px 6px;display:none;"
                    title="Catch up to tape head">↓</button>
                <span id="tts-position" style="font-size:7px;color:var(--text-muted);min-width:28px;"></span>
                <input type="range" id="tts-speed-header" min="0.5" max="3" step="0.25" value="1"
                    style="width:50px;height:4px;" onchange="setTTSSpeed(this.value)">
                <span id="tts-speed-label" style="font-size:7px;width:22px;">1x</span>
            </div>
            <button class="btn" onclick="exportTray()">Export</button>
            <button class="btn primary" onclick="downloadBib()">Bib</button>
            <button class="btn" id="fullscreen-btn" onclick="toggleFullScreen()" style="display:none;"
                title="Fullscreen">⛶</button>
            <div style="position:relative">
                <button class="settings-btn" onclick="toggleSettings()">=</button>
                <div class="settings-dropdown" id="settings-dropdown">
                    <div class="settings-section">
                        <div class="settings-row"><span>Dark Mode</span>
                            <div class="toggle-switch on" id="dark-mode-toggle" onclick="toggleTheme()"></div>
                        </div>
                        <div class="settings-row"><span>Audio</span>
                            <div class="toggle-switch on" id="audio-toggle" onclick="toggleAudio()"></div>
                        </div>
                    </div>
                    <div class="settings-section">
                        <div class="settings-label">SYSTEM</div>
                        <div class="settings-row">
                            <a href="rocky-glossary.html" target="_self"
                                style="color:var(--primary);text-decoration:none;font-size:11px;display:flex;align-items:center;gap:6px;width:100%;">
                                <span style="font-size:14px">☀</span> Glossary & Patterns
                            </a>
                        </div>
                    </div>
                    <div class="settings-section">
                        <div class="settings-label">FONT SIZE</div>
                        <div class="settings-row"><span id="font-size-val">11px</span><input type="range"
                                class="settings-slider" id="font-size-slider" min="9" max="18" value="11"
                                onchange="setFontSize(this.value)"></div>
                    </div>
                    <div class="settings-section">
                        <div class="settings-label">TTS VOICE</div>
                        <select class="settings-select" id="tts-voice" onchange="setTTSVoice(this.value)">
                            <option>Loading...</option>
                        </select>
                        <button class="tts-btn" style="margin-top:4px;width:100%;" onclick="testTTS()">Test
                            Voice</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="main-container">
        <div class="grid-panel" id="grid-panel">
            <div class="grid-nav">
                <div class="grid-tab active" id="tab-docs" onclick="showDocs()">DOCS</div>
                <div class="grid-tab" id="tab-scene" onclick="showScene()">SCENE</div>
                <div class="grid-tab tray-tab" id="tab-tray" onclick="showTrayTab()">TRAY <span
                        id="tray-badge-tab">0</span></div>
            </div>
            <div class="grid-header"><span id="grid-label">27 Documents</span><span id="grid-sublabel"></span></div>
            <div class="grid-content" id="grid-content">
                <div class="idea-grid" id="doc-grid"></div>
                <div class="idea-grid" id="scene-grid" style="display:none;"></div>
                <div class="idea-grid" id="tray-grid" style="display:none;"></div>
            </div>
        </div>
        <div class="resizer" id="resizer"></div>
        <div class="text-panel" id="text-panel">
            <div class="text-header">
                <!-- Clean Header: Just the Title -->
                <div class="text-title" id="text-title" style="font-size:12px;color:var(--secondary);">Select a document
                </div>
            </div>
            <div class="text-body">
                <div class="text-content" id="text-content">
                    <div style="padding:15px;text-align:center;color:var(--text-muted);font-size:8px;">Click an idea
                        brick to load.</div>
                    <div id="selection-popup" class="selection-popup" style="display:none;"
                        onclick="collectSelection()">
                        Collect Selection
                    </div>
                </div>
                <div class="brick-grid" id="doc-grid"></div>

                <!-- Bulk Actions Float -->
                <div class="bulk-actions" id="bulk-actions">
                    <span id="bulk-count">0 selected</span>
                    <div style="display:flex;gap:8px;">
                        <button class="btn btn-sm" onclick="exportSelectedDocs()">Export</button>
                        <button class="btn btn-sm delete" onclick="deleteSelectedDocs()">Delete</button>
                    </div>
                </div>

                <!-- Paste Modal -->
                <div class="modal-overlay" id="paste-modal" onclick="closePasteModal()">
                    <div class="modal" onclick="event.stopPropagation()">
                        <h3>Paste Document</h3>
                        <input type="text" id="paste-title" placeholder="Document Title (e.g. My Notes)"
                            style="width:100%;margin-bottom:10px;padding:8px;background:var(--bg);border:1px solid var(--border);color:var(--text-main);">
                        <textarea id="paste-content" placeholder="Paste Markdown text here..."
                            style="width:100%;height:200px;background:var(--bg);border:1px solid var(--border);color:var(--text-main);padding:8px;font-family:var(--font-mono);"></textarea>
                        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px;">
                            <button class="btn" onclick="closePasteModal()">Cancel</button>
                            <button class="btn primary" onclick="handlePasteSubmit()">Import</button>
                        </div>
                    </div>
                </div>

                <div class="minimap" id="minimap-container">
                    <canvas id="minimap"></canvas>
                    <div class="minimap-viewport" id="minimap-viewport"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tooltip -->
    <div class="brick-tooltip" id="brick-tooltip"></div>

    <!-- Selection Popup -->
    <div id="selection-popup" class="selection-popup" style="display:none;">
        <button class="btn btn-sm" onclick="collectSelection()">
            <span class="icon">⤓</span> Collect Selection
        </button>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="modal-overlay"></div>

    <!-- Tray -->
    <div class="tray-container" id="tray-container">
        <div class="tray-resize" id="tray-resize"></div>
        <div class="tray-bar" onclick="toggleTray()">
            <span class="tray-bar-title">COLLECTED</span>
            <span class="tray-bar-count" id="tray-count">0</span>
            <span class="tray-bar-preview" id="tray-preview">Drag to reorder / Add notes</span>
        </div>
        <div class="tray-content" id="tray-content">
            <div class="tray-empty">Click lines to collect. Click ✎ to add notes.</div>
        </div>
        <div class="tray-footer" id="tray-footer-actions">
            <!-- Contextual Actions -->
            <button class="btn btn-icon" id="btn-note" onclick="trayAction('note')" disabled title="Add Note">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                </svg>
            </button>
            <button class="btn btn-icon" id="btn-src" onclick="trayAction('source')" disabled title="Go to Source">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
                    <polyline points="15 3 21 3 21 9" />
                    <line x1="10" y1="14" x2="21" y2="3" />
                </svg>
            </button>
            <button class="btn btn-icon" id="btn-copy" onclick="trayAction('copy')" disabled title="Copy">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2" />
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
                </svg>
            </button>
            <button class="btn btn-icon" id="btn-del" onclick="trayAction('delete')" disabled title="Delete">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6" />
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                </svg>
            </button>
            <div style="width:1px;background:var(--border);height:24px;margin:0 8px;"></div>
            <button class="btn btn-icon" onclick="trayAction('up')" id="btn-up" disabled title="Move Up">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="19" x2="12" y2="5" />
                    <polyline points="5 12 12 5 19 12" />
                </svg>
            </button>
            <button class="btn btn-icon" onclick="trayAction('down')" id="btn-down" disabled title="Move Down">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19" />
                    <polyline points="19 12 12 19 5 12" />
                </svg>
            </button>
            <div style="flex:1"></div>
            <button class="btn btn-icon primary" id="btn-export" onclick="exportTray()" title="Export / Add to Doc">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                    <polyline points="7 10 12 15 17 10" />
                    <line x1="12" y1="15" x2="12" y2="3" />
                </svg>
            </button>
        </div>
        <input type="file" id="import-file" accept=".md,.txt" style="display:none" onchange="handleImport(event)">
    </div>

    <script>
        const state = {
            documents: [],
            index: null,
            currentDoc: null,
            currentContent: '',
            footnotes: {},
            sections: [],
            tray: [],
            sonify: true,
            selectedDocs: new Set(), // Track selected indices
            currentSectionIdx: -1,
            dragIdx: null,
            ttsVoice: null,
            ttsSpeed: 1,
            ttsPlaying: false,
            ttsUtterance: null,
            currentLineIdx: 0
        };

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(type) {
            if (!state.sonify) return;
            try {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.frequency.value = { select: 880, add: 1320, remove: 440 }[type] || 550;
                osc.type = 'sine'; gain.gain.value = 0.03;
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.03);
                osc.start(); osc.stop(audioCtx.currentTime + 0.03);
            } catch (e) { }
        }

        // TTS Setup
        function loadVoices() {
            const voices = speechSynthesis.getVoices();
            const select = document.getElementById('tts-voice');
            if (voices.length === 0) return;
            select.innerHTML = voices.map((v, i) =>
                `<option value="${i}" ${v.default ? 'selected' : ''}>${v.name.substring(0, 25)}</option>`
            ).join('');
            state.ttsVoice = voices.find(v => v.default) || voices[0];
        }
        speechSynthesis.onvoiceschanged = loadVoices;
        setTimeout(loadVoices, 100);

        function setTTSVoice(idx) {
            const voices = speechSynthesis.getVoices();
            state.ttsVoice = voices[idx];
        }

        function setTTSSpeed(val) {
            state.ttsSpeed = parseFloat(val);
            document.getElementById('tts-speed-label').textContent = val + 'x';
            document.getElementById('tts-speed-header').value = val;
        }

        function testTTS() {
            speechSynthesis.cancel();
            const utter = new SpeechSynthesisUtterance("Rocky Forager ready to read your documents.");
            if (state.ttsVoice) utter.voice = state.ttsVoice;
            utter.rate = state.ttsSpeed;
            speechSynthesis.speak(utter);
        }

        function toggleTTS() {
            if (state.ttsPlaying) {
                // Pause - stop but keep position
                pauseTTS();
                return;
            }
            // Resume from current position or start fresh
            const lines = state.currentContent.split('\n').filter(l => l.trim());
            if (lines.length === 0) return;
            state.ttsPlaying = true;
            state.ttsLines = lines;
            state.ttsTotalLines = lines.length;
            updateTTSButton(true);
            updateTTSPosition();
            document.getElementById('tts-catchup').style.display = 'none';
            readNextLine(lines);
        }

        function pauseTTS() {
            speechSynthesis.cancel();
            state.ttsPlaying = false;
            updateTTSButton(false);
            // Keep position, show catch-up button
            document.getElementById('tts-catchup').style.display = 'inline-block';
        }

        function updateTTSButton(playing) {
            const btn = document.getElementById('tts-play-header');
            if (btn) {
                btn.textContent = playing ? '⏸' : (state.currentLineIdx > 0 ? '⏵' : '▶');
                btn.style.background = playing ? 'var(--link)' : '';
                btn.style.color = playing ? 'var(--bg)' : '';
            }
        }

        function updateTTSPosition() {
            const posEl = document.getElementById('tts-position');
            if (posEl && state.ttsTotalLines) {
                posEl.textContent = `${state.currentLineIdx + 1}/${state.ttsTotalLines}`;
            }
        }

        function ttsCatchUp() {
            // Scroll to current tape head position
            const lines = state.currentContent.split('\n');
            const filteredLines = lines.filter(l => l.trim());
            if (state.currentLineIdx < filteredLines.length) {
                const rawText = filteredLines[state.currentLineIdx];
                const actualIdx = lines.findIndex((l, i) => i >= 0 && l.trim() === rawText.trim());
                if (actualIdx >= 0) {
                    const line = document.querySelector(`.line[data-line="${actualIdx}"]`);
                    if (line) {
                        line.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        line.classList.add('tts-active');
                        setTimeout(() => line.classList.remove('tts-active'), 2000);
                    }
                }
            }
            document.getElementById('tts-catchup').style.display = 'none';
        }

        function readNextLine(lines) {
            if (!state.ttsPlaying || state.currentLineIdx >= lines.length) {
                stopTTS();
                return;
            }
            const rawText = lines[state.currentLineIdx];
            const text = rawText.replace(/[#*^[\]]/g, '').replace(/\\"/g, '"').trim();
            if (!text) { state.currentLineIdx++; updateTTSPosition(); readNextLine(lines); return; }

            // Update position display
            updateTTSPosition();

            // Auto-scroll and highlight with stronger styling
            const allLines = state.currentContent.split('\n');
            state.ttsActualLineIdx = allLines.findIndex((l, i) => i >= 0 && l.trim() === rawText.trim());
            if (state.ttsActualLineIdx >= 0) {
                const line = document.querySelector(`.line[data-line="${state.ttsActualLineIdx}"]`);
                if (line) {
                    line.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    document.querySelectorAll('.line.tts-active').forEach(l => l.classList.remove('tts-active'));
                    line.classList.add('tts-active');
                }
            }

            const utter = new SpeechSynthesisUtterance(text);
            if (state.ttsVoice) utter.voice = state.ttsVoice;
            utter.rate = state.ttsSpeed;
            utter.onend = () => { state.currentLineIdx++; readNextLine(lines); };
            utter.onerror = () => { state.currentLineIdx++; readNextLine(lines); };
            state.ttsUtterance = utter;
            speechSynthesis.speak(utter);
        }

        function stopTTS() {
            speechSynthesis.cancel();
            state.ttsPlaying = false;
            state.currentLineIdx = 0;
            updateTTSButton(false);
            document.getElementById('tts-position').textContent = '';
            document.getElementById('tts-catchup').style.display = 'none';
            document.querySelectorAll('.line.tts-active').forEach(l => l.classList.remove('tts-active'));
        }

        function setFontSize(val) {
            document.getElementById('text-content').style.fontSize = val + 'px';
            document.getElementById('font-size-val').textContent = val + 'px';
        }

        // Resizers
        const resizer = document.getElementById('resizer');
        const gridPanel = document.getElementById('grid-panel');
        const textPanel = document.getElementById('text-panel'); // Assuming text-panel exists
        let isResizing = false;

        resizer.addEventListener('mousedown', () => { isResizing = true; document.body.style.cursor = 'col-resize'; document.body.style.userSelect = 'none'; });
        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            const containerWidth = document.body.clientWidth;
            const newFlex = (e.clientX / containerWidth);
            if (newFlex > 0.1 && newFlex < 0.9) {
                gridPanel.style.flex = newFlex;
                textPanel.style.flex = 1 - newFlex;
            }
        });
        document.addEventListener('mouseup', () => { isResizing = false; document.body.style.cursor = ''; document.body.style.userSelect = ''; });

        // Touch Support for Resizer
        resizer.addEventListener('touchstart', (e) => { isResizing = true; document.body.style.userSelect = 'none'; });
        document.addEventListener('touchmove', (e) => {
            if (!isResizing) return;
            const x = e.touches[0].clientX;
            const containerWidth = document.body.clientWidth;
            const newFlex = (x / containerWidth);
            if (newFlex > 0.1 && newFlex < 0.9) {
                gridPanel.style.flex = newFlex;
                textPanel.style.flex = 1 - newFlex;
            }
        });
        document.addEventListener('touchend', () => { isResizing = false; document.body.style.userSelect = ''; });

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        const trayResize = document.getElementById('tray-resize');
        let isTrayResizing = false;
        trayResize.addEventListener('mousedown', (e) => { isTrayResizing = true; document.body.style.cursor = 'ns-resize'; document.body.style.userSelect = 'none'; e.preventDefault(); });
        document.addEventListener('mousemove', (e) => {
            if (!isTrayResizing) return;
            const h = window.innerHeight - e.clientY;
            if (h > 70 && h < window.innerHeight - 80) document.documentElement.style.setProperty('--tray-height', h + 'px');
        });
        document.addEventListener('mouseup', () => { isTrayResizing = false; document.body.style.cursor = ''; document.body.style.userSelect = ''; });

        // Settings
        function toggleSettings() { document.getElementById('settings-dropdown').classList.toggle('open'); }
        function toggleTheme() {
            const isDark = document.documentElement.dataset.theme === 'dark';
            document.documentElement.dataset.theme = isDark ? 'light' : 'dark';
            document.getElementById('dark-mode-toggle').classList.toggle('on', !isDark);
        }
        function toggleAudio() { state.sonify = !state.sonify; document.getElementById('audio-toggle').classList.toggle('on', state.sonify); }
        document.addEventListener('click', (e) => { if (!e.target.closest('.settings-btn') && !e.target.closest('.settings-dropdown')) document.getElementById('settings-dropdown').classList.remove('open'); });

        // Tooltip
        const tooltip = document.getElementById('brick-tooltip');
        let tooltipTimeout = null;

        function showTooltip(e, fullText) {
            clearTimeout(tooltipTimeout);
            tooltip.textContent = fullText;

            // Calculate position keeping tooltip on screen
            const tooltipWidth = 180; // max-width from CSS
            const tooltipHeight = 80; // estimated
            let left = e.clientX + 10;
            let top = e.clientY + 10;

            // Keep within viewport
            if (left + tooltipWidth > window.innerWidth) {
                left = e.clientX - tooltipWidth - 10;
            }
            if (top + tooltipHeight > window.innerHeight) {
                top = e.clientY - tooltipHeight - 10;
            }
            if (left < 0) left = 10;
            if (top < 0) top = 10;

            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
            tooltipTimeout = setTimeout(() => tooltip.classList.add('visible'), 300);
        }

        function hideTooltip() {
            clearTimeout(tooltipTimeout);
            tooltip.classList.remove('visible');
        }

        // Tabs
        function showDocs() {
            document.querySelectorAll('.grid-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-docs').classList.add('active');
            document.getElementById('doc-grid').style.display = 'grid';
            document.getElementById('scene-grid').style.display = 'none';
            document.getElementById('tray-grid').style.display = 'none';
            document.getElementById('grid-label').textContent = '27 Documents';
        }
        function showScene() {
            if (!state.currentDoc) return;
            document.querySelectorAll('.grid-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-scene').classList.add('active');
            document.getElementById('doc-grid').style.display = 'none';
            document.getElementById('scene-grid').style.display = 'grid';
            document.getElementById('tray-grid').style.display = 'none';
            document.getElementById('grid-label').textContent = state.currentDoc.title.substring(0, 16);
        }
        function showTrayTab() {
            document.querySelectorAll('.grid-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-tray').classList.add('active');
            document.getElementById('doc-grid').style.display = 'none';
            document.getElementById('scene-grid').style.display = 'none';
            document.getElementById('tray-grid').style.display = 'grid';
            document.getElementById('grid-label').textContent = 'Collected';
            renderTrayGrid();
            renderTrayAsDocument();
            document.getElementById('tray-container').classList.add('open');
        }

        function renderTrayAsDocument() {
            const container = document.getElementById('text-content');
            document.getElementById('file-path').textContent = 'FRANKENSTEIN DOC';
            document.getElementById('text-title').textContent = 'Assembled from ' + state.tray.length + ' sources';

            if (state.tray.length === 0) {
                container.innerHTML = '<div style="padding:30px;text-align:center;color:var(--text-muted);">Collect lines from documents to build your Frankenstein paper.</div>';
                return;
            }

            let html = '<div class="line h1"><div class="ln"></div><div class="line-text">FRANKENSTEIN DOCUMENT</div></div>';
            html += '<div class="line"><div class="ln"></div><div class="line-text" style="color:var(--text-muted);font-size:10px;">Assembled from ' + state.tray.length + ' transcluded sources</div></div>';
            html += '<div class="line"><div class="ln"></div><div class="line-text">&nbsp;</div></div>';

            state.tray.forEach((item, idx) => {
                const text = formatText(item.editedText);
                const note = item.note ? `<div style="color:var(--note);font-size:9px;margin-top:4px;">📝 ${escapeHtml(item.note)}</div>` : '';
                const cites = item.citations.map(c => c.fullBib ? `<div style="font-size:8px;color:var(--citation);margin-top:2px;">[${c.num}] ${escapeHtml(c.fullBib.substring(0, 120))}...</div>` : '').join('');

                html += `
                    <div class="line" style="border-left:3px solid var(--tray);margin-bottom:8px;padding:8px;background:var(--panel);border-radius:0 4px 4px 0;">
                        <div class="ln" style="font-size:6px;opacity:0.5;">${idx + 1}</div>
                        <div class="line-text">
                            <div style="font-size:7px;color:var(--text-muted);margin-bottom:4px;font-family:var(--font-mono);">
                                ↩ ${item.docTitle} • Line ${item.lineIndex + 1}
                                <span style="cursor:pointer;color:var(--link);" onclick="goToItem(${idx})"> [Go to source]</span>
                            </div>
                            <div style="font-size:11px;line-height:1.5;">${text}</div>
                            ${note}
                            ${cites}
                        </div>
                    </div>
                `;
            });

            // Add bibliography
            const allCites = new Map();
            state.tray.forEach(item => item.citations.forEach(c => { if (c.fullBib && !allCites.has(c.num)) allCites.set(c.num, c.fullBib); }));
            if (allCites.size > 0) {
                html += '<div class="line h2"><div class="ln"></div><div class="line-text">Bibliography</div></div>';
                [...allCites.entries()].sort((a, b) => +a[0] - +b[0]).forEach(([n, b]) => {
                    html += `<div class="line"><div class="ln" style="font-size:8px;">[${n}]</div><div class="line-text" style="font-size:9px;color:var(--citation);">${escapeHtml(b)}</div></div>`;
                });
            }

            container.innerHTML = html;
            state.currentContent = generateExport();
        }

        // Init
        async function init() {
            try {
                // Attempt to load corpus. If CORS blocks this (file://), we catch it and continue.
                const res = await fetch('corpus_index.json');
                if (!res.ok) throw new Error("404");
                state.index = await res.json();
                state.documents = Object.entries(state.index.files).map(([name, info]) => ({
                    name, title: name.replace('.md', ''),
                    themes: info.themes || [], sections: info.sections || 0, citations: info.citations || 0
                }));
            } catch (err) {
                console.warn('Corpus load failed (likely CORS or missing file). Starting with Local Mode.', err);
                const welcomeMD = `
# Welcome to Rocky Forager
> "The tool should be ready-to-hand, visible only when it breaks down."

**You are in Local Mode.** 
Because this file is running directly from your computer (file://), it cannot load external documents automatically for security reasons.

## Getting Started
1. Click **+ Add** in the grid above.
2. **Import** a markdown file or **Paste** your text.
3. Start foraging!

## Quick Tips
- **Click** a line to capture it to your Tray.
- **Drag** bricks in the grid to reorder your thoughts.
- **Export** your tray to get a formatted paper with citations.

*Happy Foraging!*
`;
                state.documents = [{
                    name: 'welcome.md', title: 'Welcome / Offline',
                    themes: ['system'], sections: 3, citations: 0,
                    content: welcomeMD
                }];
            }

            // App continues to load
            renderDocumentGrid(); // Always render the grid first

            if (state.documents.length > 0) {
                // Load the first doc (Welcome or Real)
                selectDocument(0);
            } else {
                renderDocumentGrid();
            }

            // Restore session if possible (mock)
            updateTrayBadges();
        }

        function renderDocumentGrid() {
            const grid = document.getElementById('doc-grid');
            grid.innerHTML = '';

            // "Add Doc" Brick
            const addBrick = document.createElement('div');
            addBrick.className = 'brick add-doc-brick';
            addBrick.innerHTML = `<div class="brick-title" style="color:var(--secondary);font-weight:bold;">+ Add</div>`;
            addBrick.onclick = () => {
                // Simple toggle for now: if Paste Modal open, close it? Or just open import?
                // Let's open Paste Modal which has an Import button inside or near it?
                // Used requested "Import as a cell". Let's show a context menu or just open Paste Modal for now as the "Add Hub".
                openPasteModal();
            };
            addBrick.title = "Import File or Paste Text";
            grid.appendChild(addBrick);

            state.documents.forEach((doc, idx) => {
                const brick = document.createElement('div');
                brick.className = 'brick doc';
                brick.dataset.index = idx;

                // Selection State
                if (state.selectedDocs.has(idx)) brick.classList.add('selected');
                if (state.currentDoc === doc) brick.classList.add('active');

                // Drag & Drop Attributes
                brick.setAttribute('draggable', 'true');
                brick.addEventListener('dragstart', (e) => handleDragStart(e, idx));
                brick.addEventListener('dragover', handleDragOver);
                brick.addEventListener('drop', (e) => handleDrop(e, idx));
                brick.addEventListener('dragenter', handleDragEnter);
                brick.addEventListener('dragleave', handleDragLeave);

                // 1. Set Title First
                brick.innerHTML = `<div class="brick-title">${doc.title.split(/[\s_-]+/).slice(0, 5).join(' ')}</div><div class="brick-symbol">D</div>`;

                // 2. Heatmap Calculation (Append Badge + Apply Style)
                const collectedCount = state.tray.filter(item => item.doc === doc.name).length;
                if (collectedCount > 0) {
                    // Red Heatmap: Base redness increases with count
                    const intensity = Math.min(collectedCount / 10, 1.0);
                    brick.style.setProperty('background-color', `rgba(247, 118, 142, ${0.2 + (intensity * 0.6)})`, 'important');
                    brick.style.setProperty('border-color', `rgba(247, 118, 142, ${0.4 + (intensity * 0.6)})`, 'important');
                    brick.title = `${doc.title} (${collectedCount} collected)`;
                    brick.innerHTML += `<div class="brick-badge" style="position:absolute;top:-4px;right:-4px;background:var(--danger);color:white;font-size:8px;padding:2px 4px;border-radius:4px;">${collectedCount}</div>`;
                }

                brick.onclick = (e) => {
                    playSound('select');
                    if (e.metaKey || e.ctrlKey || e.shiftKey) {
                        toggleDocSelection(idx, e.shiftKey);
                    } else {
                        // Single click acts as selection if we are in "bulk mode"?
                        // UX Decision: Click opens doc. Cmd+Click selects.
                        // If multiple selected, click clears and opens.
                        if (state.selectedDocs.size > 0 && !state.selectedDocs.has(idx)) {
                            clearDocSelection();
                        }
                        selectDocument(idx);
                    }
                };
                brick.onmouseenter = (e) => showTooltip(e, doc.title);
                brick.onmouseleave = hideTooltip;
                grid.appendChild(brick);
            });
            updateBulkActions();
        }

        let dragSrcEl = null;

        function handleDragStart(e, idx) {
            dragSrcEl = idx;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', idx);
            e.target.classList.add('dragging');
            playSound('select');
        }

        function handleDragOver(e) {
            if (e.preventDefault) e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            e.target.closest('.brick')?.classList.add('over');
        }

        function handleDragLeave(e) {
            e.target.closest('.brick')?.classList.remove('over');
        }

        function handleDrop(e, targetIdx) {
            if (e.stopPropagation) e.stopPropagation();

            const srcIdx = parseInt(e.dataTransfer.getData('text/plain'));
            if (srcIdx !== targetIdx) {
                // Reorder state.documents
                const movedItem = state.documents[srcIdx];
                state.documents.splice(srcIdx, 1);
                state.documents.splice(targetIdx, 0, movedItem);

                // Clear selection if reordering (too complex to map selection indices for now)
                state.selectedDocs.clear();

                renderDocumentGrid();
                playSound('add');
            }
            return false;
        }

        function toggleDocSelection(idx, isShift) {
            if (state.selectedDocs.has(idx)) {
                state.selectedDocs.delete(idx);
            } else {
                state.selectedDocs.add(idx);
            }
            // Simple Shift logic (range) could be added here, keeping it simple for now
            renderDocumentGrid();
        }

        function selectAllDocs() {
            state.documents.forEach((_, i) => state.selectedDocs.add(i));
            renderDocumentGrid();
        }

        function clearDocSelection() {
            state.selectedDocs.clear();
            renderDocumentGrid();
        }

        function updateBulkActions() {
            const bar = document.getElementById('bulk-actions');
            const count = document.getElementById('bulk-count');
            if (state.selectedDocs.size > 0) {
                bar.classList.add('visible');
                count.textContent = `${state.selectedDocs.size} selected`;
            } else {
                bar.classList.remove('visible');
            }
        }

        function deleteSelectedDocs() {
            if (!confirm(`Delete ${state.selectedDocs.size} documents?`)) return;
            // Sort descending to remove without index shift issues
            const indices = Array.from(state.selectedDocs).sort((a, b) => b - a);
            indices.forEach(i => state.documents.splice(i, 1));
            clearDocSelection();
            if (state.documents.length > 0) selectDocument(0);
            else { state.currentDoc = null; state.currentContent = ''; renderSceneGrid(); renderContent(); }
        }

        function exportSelectedDocs() {
            let out = `# Bulk Export (${state.selectedDocs.size} docs)\n\n`;
            state.selectedDocs.forEach(idx => {
                const doc = state.documents[idx];
                out += `## ${doc.title}\n\n(Content would verify here via fetch... skipped for prototype speed)\n\n`;
            });
            // Ideally we'd fetch all content. For now let's just export the list.
            alert("Exporting " + state.selectedDocs.size + " docs (Metadata only for V1)");
        }

        async function selectDocument(idx) {
            const doc = state.documents[idx];
            if (!doc) return;
            document.querySelectorAll('#doc-grid .brick').forEach(b => b.classList.remove('active'));
            document.querySelector(`#doc-grid .brick[data-index="${idx}"]`)?.classList.add('active');
            state.currentDoc = doc;
            // Removed redundant file-path update
            const count = state.tray.filter(i => i.doc === doc.name).length;
            document.getElementById('text-title').innerHTML = `${doc.title} ${count > 0 ? `<span style="color:var(--accent);font-size:10px;margin-left:8px;">(${count} collected)</span>` : ''}`;
            if (doc.content) {
                state.currentContent = doc.content;
                finishLoad();
            } else {
                try {
                    const res = await fetch(`../markdown/${doc.name}`);
                    state.currentContent = await res.text();
                    finishLoad();
                } catch (err) { console.error('Failed:', err); }
            }
        }

        function finishLoad() {
            parseFootnotes(); parseSections(); renderSceneGrid(); renderContent(); renderMinimap(); showScene();
        }

        function parseFootnotes() {
            state.footnotes = {};
            const lines = state.currentContent.split('\n');
            let inBib = false, num = null, txt = '';
            for (const line of lines) {
                if (/^#{1,4}\s*(Works cited|References|Bibliography)/i.test(line)) { inBib = true; continue; }
                if (inBib) {
                    const m = line.match(/^(\d+)\.\s+(.+)/);
                    if (m) { if (num) state.footnotes[num] = txt.trim(); num = m[1]; txt = m[2]; }
                    else if (num && line.trim()) txt += ' ' + line.trim();
                }
            }
            if (num) state.footnotes[num] = txt.trim();
        }

        function parseSections() {
            state.sections = [];
            state.currentContent.split('\n').forEach((line, idx) => {
                const h1 = line.match(/^#\s+(.+)/), h2 = line.match(/^##\s+(.+)/), h3 = line.match(/^###\s+(.+)/);
                if (h1) state.sections.push({ type: 'h1', title: h1[1], lineIndex: idx, symbol: 'H1' });
                else if (h2) state.sections.push({ type: 'h2', title: h2[1], lineIndex: idx, symbol: 'H2' });
                else if (h3) state.sections.push({ type: 'h3', title: h3[1], lineIndex: idx, symbol: '§' });
                else if (/\^\d+\^/.test(line) && line.length > 100) state.sections.push({ type: 'cite', title: line.substring(0, 55) + '...', lineIndex: idx, symbol: 'C' });
            });
        }

        function renderSceneGrid() {
            const grid = document.getElementById('scene-grid');
            grid.innerHTML = '';
            state.sections.forEach((sec, i) => {
                const brick = document.createElement('div');
                brick.className = `brick ${sec.type}`; brick.dataset.index = i;

                // Check if in tray
                if (state.tray.some(item => item.doc === state.currentDoc?.name && item.lineIndex === sec.lineIndex)) brick.classList.add('in-tray');
                // Check if has note
                const trayItem = state.tray.find(item => item.doc === state.currentDoc?.name && item.lineIndex === sec.lineIndex);
                if (trayItem && trayItem.note) brick.classList.add('has-note');

                brick.innerHTML = `<div class="brick-title">${sec.title}</div><div class="brick-symbol">${sec.symbol}</div>`;

                brick.onclick = () => { playSound('select'); scrollToLineAndHighlight(sec.lineIndex); highlightSceneBrick(i); };
                brick.onmouseenter = (e) => { showTooltip(e, sec.title); highlightLineTemporary(sec.lineIndex); };
                brick.onmouseleave = hideTooltip;

                grid.appendChild(brick);
            });
        }

        function renderTrayGrid() {
            const grid = document.getElementById('tray-grid');
            grid.innerHTML = '';
            if (state.tray.length === 0) {
                grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:20px;color:var(--text-muted);font-size:8px;">No collected ideas yet</div>';
                return;
            }
            state.tray.forEach((item, idx) => {
                const brick = document.createElement('div');
                brick.className = 'brick h2 in-tray';
                if (item.note) brick.classList.add('has-note');
                brick.innerHTML = `<div class="brick-title">${item.editedText.substring(0, 60)}...</div><div class="brick-symbol">T${idx + 1}</div>`;
                brick.onclick = () => { goToItem(idx); };
                brick.onmouseenter = (e) => showTooltip(e, item.editedText.substring(0, 200));
                brick.onmouseleave = hideTooltip;
                grid.appendChild(brick);
            });
        }

        function highlightSceneBrick(idx) {
            document.querySelectorAll('#scene-grid .brick').forEach(b => b.classList.remove('active', 'current'));
            document.querySelector(`#scene-grid .brick[data-index="${idx}"]`)?.classList.add('active');
            state.currentSectionIdx = idx;
        }

        function highlightLineTemporary(lineIndex) {
            const line = document.querySelector(`.line[data-line="${lineIndex}"]`);
            if (line) {
                line.classList.add('highlight');
                setTimeout(() => line.classList.remove('highlight'), 1500);
            }
        }

        function scrollToLineAndHighlight(lineIndex) {
            const line = document.querySelector(`.line[data-line="${lineIndex}"]`);
            if (line) {
                line.scrollIntoView({ behavior: 'smooth', block: 'center' });
                document.querySelectorAll('.line.highlight').forEach(l => l.classList.remove('highlight'));
                line.classList.add('highlight');
                setTimeout(() => line.classList.remove('highlight'), 2500);
            }
        }

        function formatText(text) {
            // Fix escaped quotes and format text
            let t = escapeHtml(text);
            t = t.replace(/\\"/g, '"');  // Fix escaped quotes
            t = t.replace(/\*\*(.+?)\*\*/g, '<span class="md-bold">$1</span>');
            t = t.replace(/\^(\d+)\^/g, '<span class="cite-ref">[$1]</span>');
            // Style blockquotes
            if (t.startsWith('&gt; ')) {
                t = '<div class="md-quote">' + t.substring(5) + '</div>';
            }
            return t;
        }

        function renderContent() {
            const container = document.getElementById('text-content');
            if (!state.currentContent) {
                container.innerHTML = '';
                return;
            }
            const lines = state.currentContent.split('\n');
            container.innerHTML = lines.map((line, idx) => {
                let cls = 'line';
                if (line.startsWith('# ')) cls += ' h1';
                else if (line.startsWith('## ')) cls += ' h2';
                else if (line.startsWith('### ')) cls += ' h3';
                const trayItem = state.tray.find(item => item.doc === state.currentDoc?.name && item.lineIndex === idx);
                if (trayItem) cls += ' in-tray';
                if (trayItem && trayItem.note) cls += ' has-note';

                // Active TTS line check (optional, but good for persistence)
                // Assuming tts logic handles class toggling dynamically for now.

                const text = formatText(line);
                return `<div class="${cls}" data-line="${idx}" onclick="collectLine(${idx})"><div class="ln">${idx + 1}</div><div class="line-text">${text || '&nbsp;'}</div></div>`;
            }).join('');
            container.addEventListener('scroll', handleScroll);
        }

        function renderTray() {
            const content = document.getElementById('tray-content');
            updateTrayBadges();
            document.getElementById('tray-preview').textContent = state.tray.length > 0 ? 'Drag to reorder' : 'Click lines to collect';

            if (state.tray.length === 0) {
                content.innerHTML = `<div class="tray-empty">Click lines in the document to collect ideas.</div>`;
                updateFooterActions(); // Ensure footer is disabled
                return;
            }

            content.innerHTML = state.tray.map((item, idx) => {
                const citeText = item.citations.length > 0 ?
                    item.citations.map(c => `<span class="cite-num">[${c.num}]</span> <span class="cite-body">${c.fullBib || ''}</span>`).join(' ') : '';

                const isSelected = state.selectedTrayIdx === idx;

                return `
            <div class="tray-item ${item.note ? 'has-note' : ''} ${isSelected ? 'selected' : ''}" 
                 data-idx="${idx}" draggable="true" onclick="selectTrayItem(${idx})">
                
                <!-- Note Column (Square Grid) -->
                <div class="tray-item-note-column">
                    <div class="tray-item-meta" style="margin-bottom:4px;display:flex;justify-content:space-between;width:100%;">
                        <span class="tray-item-num" style="color:var(--text-muted);font-size:10px;">#${idx + 1}</span>
                    </div>
                    <div class="tray-item-note-inline ${item.note ? 'visible' : ''}" 
                         contenteditable="true" data-idx="${idx}" 
                         oninput="updateNote(${idx}, this.innerText)" 
                         onclick="event.stopPropagation()">
                         ${escapeHtml(item.note || '')}
                    </div>
                </div>

                <!-- Content Column -->
                <div class="tray-item-content-column">
                    <div class="tray-item-body" contenteditable="true" data-idx="${idx}" 
                         oninput="updateItemText(${idx}, this.innerText)" 
                         onclick="event.stopPropagation(); selectTrayItem(${idx})">
                        ${formatText(item.editedText)}
                    </div>
                    ${citeText ? `<div class="tray-item-citation ${isSelected ? 'expanded' : ''}" onclick="event.stopPropagation();this.classList.toggle('expanded')" title="Click to expand">${citeText}</div>` : ''}
                </div>

                <!-- Drag Handle -->
                <div class="tray-drag-handle" title="Drag to reorder">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg>
                </div>
            </div>
        `;
            }).join('');

            // Drag handlers
            document.querySelectorAll('.tray-item').forEach(el => {
                el.addEventListener('dragstart', handleDragStart);
                el.addEventListener('dragend', handleDragEnd);
                el.addEventListener('dragover', handleDragOver);
                el.addEventListener('drop', handleDrop);
                el.addEventListener('dragleave', handleDragLeave);
            });

            // Update footer state
            updateFooterActions();
        }

        function selectTrayItem(idx) {
            state.selectedTrayIdx = idx;

            // Visual update without full re-render for performance/focus retention
            document.querySelectorAll('.tray-item').forEach((el, i) => {
                if (i === idx) {
                    el.classList.add('selected');
                    el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    el.classList.remove('selected');
                }
            });

            updateFooterActions();
        }

        function updateFooterActions() {
            const hasSel = state.selectedTrayIdx !== null;
            ['btn-note', 'btn-src', 'btn-copy', 'btn-del', 'btn-up', 'btn-down'].forEach(id => {
                document.getElementById(id).disabled = !hasSel;
            });
            document.getElementById('btn-export').disabled = state.tray.length === 0;
            document.getElementById('tray-count').textContent = state.tray.length;
        }

        // Restored Functions
        function trayAction(action) {
            if (state.selectedTrayIdx === null && action !== 'export' && action !== 'clear') return;
            const idx = state.selectedTrayIdx;

            if (action === 'delete') {
                if (idx !== null) {
                    state.tray.splice(idx, 1);
                    state.selectedTrayIdx = null;
                    renderTray();
                }
            } else if (action === 'note') {
                // Focus the note field of selected item
                const noteEl = document.querySelector(`.tray-item[data-idx="${idx}"] .tray-item-note-inline`);
                if (noteEl) {
                    noteEl.focus();
                    // Highlight effect
                    noteEl.style.transition = 'none';
                    noteEl.style.backgroundColor = 'rgba(255, 236, 179, 0.5)';
                    setTimeout(() => noteEl.style.backgroundColor = '', 300);
                }
            } else if (action === 'source') {
                goToItem(idx);
            } else if (action === 'copy') {
                copyItem(idx);
            } else if (action === 'up') {
                if (idx > 0) {
                    const item = state.tray.splice(idx, 1)[0];
                    state.tray.splice(idx - 1, 0, item);
                    state.selectedTrayIdx--;
                    renderTray();
                }
            } else if (action === 'down') {
                if (idx < state.tray.length - 1) {
                    const item = state.tray.splice(idx, 1)[0];
                    state.tray.splice(idx + 1, 0, item);
                    state.selectedTrayIdx++;
                    renderTray();
                }
            }
        }

        function handleScroll() {
            const container = document.getElementById('text-content');
            const rect = container.getBoundingClientRect();
            let currentIdx = -1;
            for (let i = state.sections.length - 1; i >= 0; i--) {
                const el = document.querySelector(`.line[data-line="${state.sections[i].lineIndex}"]`);
                if (el && el.getBoundingClientRect().top <= rect.top + 40) { currentIdx = i; break; }
            }
            if (currentIdx !== state.currentSectionIdx && currentIdx >= 0) {
                state.currentSectionIdx = currentIdx;
                document.querySelectorAll('#scene-grid .brick').forEach(b => b.classList.remove('current'));
                const brick = document.querySelector(`#scene-grid .brick[data-index="${currentIdx}"]`);
                if (brick) { brick.classList.add('current'); brick.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }
            }
            updateMinimapViewport();
        }

        function renderMinimap() {
            const canvas = document.getElementById('minimap');
            const container = document.getElementById('minimap-container');
            const lines = state.currentContent.split('\n');
            const rect = container.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            canvas.width = rect.width * dpr; canvas.height = rect.height * dpr;
            canvas.style.width = rect.width + 'px'; canvas.style.height = rect.height + 'px';
            const ctx = canvas.getContext('2d');
            ctx.scale(dpr, dpr); ctx.clearRect(0, 0, rect.width, rect.height);
            const lineH = rect.height / lines.length;
            lines.forEach((line, i) => {
                if (!line.trim()) return;
                let color = '#2a2a3a';
                if (line.startsWith('# ')) color = '#bb9af7';
                else if (line.startsWith('## ')) color = '#7aa2f7';
                else if (line.startsWith('### ')) color = '#73daca';
                else if (/\^\d+\^/.test(line)) color = '#e0af68';
                ctx.fillStyle = color;
                ctx.fillRect(1, i * lineH, Math.min(rect.width - 2, line.length * 0.3), Math.max(1, lineH - 0.2));
            });
            canvas.onclick = (e) => { scrollToLineAndHighlight(Math.floor((e.offsetY / rect.height) * lines.length)); };
        }

        function updateMinimapViewport() {
            const c = document.getElementById('text-content'), v = document.getElementById('minimap-viewport'), m = document.getElementById('minimap-container');
            const sp = c.scrollTop / c.scrollHeight, vp = c.clientHeight / c.scrollHeight;
            v.style.top = (sp * m.clientHeight) + 'px'; v.style.height = (vp * m.clientHeight) + 'px';
        }

        function collectLine(lineIndex) {
            if (!state.currentDoc) return;
            const lines = state.currentContent.split('\n');
            const lineText = lines[lineIndex];
            const existing = state.tray.findIndex(item => item.doc === state.currentDoc.name && item.lineIndex === lineIndex);
            // Toggle
            if (existing >= 0) {
                state.tray.splice(existing, 1);
                playSound('remove');
            } else {
                const cites = (lineText.match(/\^(\d+)\^/g) || []).map(m => ({ num: m.replace(/\^/g, ''), fullBib: state.footnotes[m.replace(/\^/g, '')] || '' }));
                state.tray.push({
                    id: Date.now(), doc: state.currentDoc.name, docTitle: state.currentDoc.title,
                    lineIndex, originalText: lineText, editedText: lineText.replace(/\^(\d+)\^/g, '[$1]'),
                    citations: cites, note: ''
                });
                playSound('add');
            }
            renderTray();
            renderContent();
            renderSceneGrid();
            renderDocumentGrid(); // Update Heatmap immediately
            updateTrayBadges();

            // Update Header Count immediately
            const count = state.tray.filter(i => i.doc === state.currentDoc.name).length;
            document.getElementById('text-title').innerHTML = `${state.currentDoc.title} <span style="color:var(--accent);font-size:10px;margin-left:8px;">(${count} collected)</span>`;
        }

        function updateTrayBadges() {
            document.getElementById('tray-count').textContent = state.tray.length;
        }

        // Tray
        function toggleTray() { document.getElementById('tray-container').classList.toggle('open'); }


        function toggleNote(idx) {
            const item = document.querySelector(`.tray-item[data-idx="${idx}"] .tray-item-note-inline`);
            if (item) {
                item.classList.toggle('visible');
                if (item.classList.contains('visible')) item.focus();
            }
        }

        function updateNote(idx, text) {
            if (state.tray[idx]) {
                state.tray[idx].note = text;
                // Update tray item class and views
                const trayItem = document.querySelector(`.tray-item[data-idx="${idx}"]`);
                if (trayItem) trayItem.classList.toggle('has-note', !!text);
                // Update grid and text views to show note marker
                renderSceneGrid();
                renderContent();
            }
        }

        function moveItemUp(idx) {
            if (idx > 0) {
                const item = state.tray.splice(idx, 1)[0];
                state.tray.splice(idx - 1, 0, item);
                renderTray();
                playSound('add');
            }
        }

        function updateItemText(idx, text) {
            if (state.tray[idx]) state.tray[idx].editedText = text;
        }

        function handleDragStart(e) {
            state.dragIdx = parseInt(e.currentTarget.dataset.idx);
            e.currentTarget.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }
        function handleDragEnd(e) {
            e.currentTarget.classList.remove('dragging');
            document.querySelectorAll('.tray-item').forEach(el => el.classList.remove('drag-over'));
        }
        function handleDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; e.currentTarget.classList.add('drag-over'); }
        function handleDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }
        function handleDrop(e) {
            e.preventDefault();
            const targetIdx = parseInt(e.currentTarget.dataset.idx);
            if (state.dragIdx !== null && state.dragIdx !== targetIdx) {
                const item = state.tray.splice(state.dragIdx, 1)[0];
                state.tray.splice(targetIdx, 0, item);
                playSound('select'); renderTray();
            }
            state.dragIdx = null;
        }

        function copyItem(idx) {
            const item = state.tray[idx];
            if (!item) return;
            let text = `> ${item.editedText}\n> — ${item.docTitle}, Line ${item.lineIndex + 1}`;
            if (item.note) text += `\n\n[Note: ${item.note}]`;
            item.citations.forEach(c => { if (c.fullBib) text += `\n\n[${c.num}]: ${c.fullBib}`; });
            navigator.clipboard.writeText(text); playSound('select');
        }

        function goToItem(idx) {
            const item = state.tray[idx];
            if (!item) return;
            if (item.doc !== state.currentDoc?.name) {
                const docIdx = state.documents.findIndex(d => d.name === item.doc);
                if (docIdx >= 0) selectDocument(docIdx).then(() => setTimeout(() => scrollToLineAndHighlight(item.lineIndex), 300));
            } else scrollToLineAndHighlight(item.lineIndex);
        }

        function removeFromTray(idx) { state.tray.splice(idx, 1); playSound('remove'); renderTray(); renderContent(); renderSceneGrid(); updateTrayBadges(); }
        function clearTray() { state.tray = []; renderTray(); renderContent(); renderSceneGrid(); updateTrayBadges(); }

        function copyTray() { navigator.clipboard.writeText(generateExport()); playSound('select'); }

        function exportTray() {
            const blob = new Blob([generateExport()], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url;
            a.download = `forager_${(state.currentDoc?.title || 'ideas').replace(/\s+/g, '_').substring(0, 18)}_${new Date().toISOString().split('T')[0]}.md`;
            a.click(); URL.revokeObjectURL(url);
        }

        function generateExport() {
            // One-Shot Paper Generation
            const date = new Date().toISOString().split('T')[0];
            let out = `# Rocky Forager Paper\nDate: ${date}\n\n`;

            const bibMap = new Map(); // Maps citation num -> Full Bib Text

            // linear Synthesis
            state.tray.forEach(item => {
                // Collect citations for this item
                let citeKeys = '';
                item.citations.forEach(c => {
                    if (c.fullBib) {
                        // Unique Key: [Title-Num] to avoid collisions across docs
                        const safeTitle = item.docTitle.replace(/[^a-zA-Z0-9]/g, '').substring(0, 3).toUpperCase();
                        const key = `${safeTitle}-${c.num}`;
                        bibMap.set(key, c.fullBib);
                        citeKeys += `[^${key}]`;
                    }
                });

                // Formatting Logic:
                if (item.note) {
                    out += `${item.note} ${citeKeys}\n\n`;
                    out += `> ${item.editedText}\n> — *${item.docTitle}, Line ${item.lineIndex + 1}*\n\n`;
                } else {
                    out += `> ${item.editedText} ${citeKeys}\n> — *${item.docTitle}, Line ${item.lineIndex + 1}*\n\n`;
                }
            });

            // Works Cited
            if (bibMap.size > 0) {
                out += `---\n\n## Works Cited\n\n`;
                const sortedBib = [...bibMap.entries()].sort();
                sortedBib.forEach(([key, text]) => {
                    out += `[^${key}]: ${text}\n\n`;
                });
            }

            return out;
        }

        async function downloadBib() { const a = document.createElement('a'); a.href = 'clean_bibliography.bib'; a.download = 'corpus_bibliography.bib'; a.click(); }

        function escapeHtml(str) { return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }

        // Import functions
        function importDoc() {
            document.getElementById('import-file').click();
        }

        async function handleImport(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const text = await file.text();
                loadImportedContent(file.name, text);
            }
            event.target.value = '';
        }

        // Paste Modal
        function openPasteModal() { document.getElementById('paste-modal').classList.add('open'); document.getElementById('paste-title').focus(); }
        function closePasteModal() { document.getElementById('paste-modal').classList.remove('open'); }

        function handlePasteSubmit() {
            const title = document.getElementById('paste-title').value.trim() || 'Untitled Paste';
            const content = document.getElementById('paste-content').value;
            if (!content) return;
            loadImportedContent(title + '.md', content);
            closePasteModal();
            // Clear inputs
            document.getElementById('paste-title').value = '';
            document.getElementById('paste-content').value = '';
        }

        // Text Selection Logic
        document.getElementById('text-content').addEventListener('mouseup', handleTextSelection);

        function handleTextSelection() {
            const sel = window.getSelection();
            const popup = document.getElementById('selection-popup');

            if (sel.isCollapsed || sel.rangeCount === 0) {
                popup.style.display = 'none';
                return;
            }

            const range = sel.getRangeAt(0);
            const container = document.getElementById('text-content');
            if (!container.contains(range.commonAncestorContainer)) {
                popup.style.display = 'none';
                return;
            }

            // Simple logic: If selection exists, show button
            popup.style.display = 'block';
        }

        function collectSelection() {
            const sel = window.getSelection();
            if (sel.isCollapsed) return;

            // Find all .line elements touched by selection
            const lines = document.querySelectorAll('.line');
            const range = sel.getRangeAt(0);

            lines.forEach((line, idx) => {
                if (sel.containsNode(line, true)) {
                    collectLine(idx, true); // true = silent/no-scroll
                }
            });

            sel.removeAllRanges();
            document.getElementById('selection-popup').style.display = 'none';
            playSound('add');
        }

        function loadImportedContent(name, content) {
            const doc = {
                name: name,
                title: name.replace('.md', '').replace('.txt', ''),
                themes: ['imported'],
                sections: content.split('\n').filter(l => l.startsWith('#')).length,
                citations: (content.match(/\^\d+\^/g) || []).length,
                content: content // Store content for memory docs
            };
            state.documents.unshift(doc);
            state.currentDoc = doc;
            state.currentContent = content;
            document.getElementById('file-path').textContent = 'IMPORTED: ' + name;
            document.getElementById('text-title').textContent = doc.title;
            finishLoad();
            renderDocumentGrid();
            playSound('add');
        }

        // Add Frankenstein doc from tray
        function addFrankensteinDoc() {
            if (state.tray.length === 0) return;
            const name = 'Frankenstein_' + new Date().toISOString().split('T')[0] + '.md';
            const content = generateExport();
            const doc = {
                name: name,
                title: 'Frankenstein Doc (' + state.tray.length + ' items)',
                themes: ['assembled'],
                sections: state.tray.length,
                citations: state.tray.reduce((sum, item) => sum + item.citations.length, 0)
            };
            state.documents.unshift(doc);
            state.currentDoc = doc;
            state.currentContent = content;
            document.getElementById('file-path').textContent = 'ASSEMBLED: ' + name;
            document.getElementById('text-title').textContent = doc.title;
            parseFootnotes();
            parseSections();
            renderDocumentGrid();
            renderSceneGrid();
            renderContent();
            showScene();
            playSound('add');
        }

        // Drag and drop import
        document.getElementById('text-content').addEventListener('dragover', (e) => {
            e.preventDefault();
            e.currentTarget.style.outline = '2px dashed var(--link)';
        });
        document.getElementById('text-content').addEventListener('dragleave', (e) => {
            e.currentTarget.style.outline = '';
        });
        document.getElementById('text-content').addEventListener('drop', (e) => {
            e.preventDefault();
            e.currentTarget.style.outline = '';
            const file = e.dataTransfer.files[0];
            if (file && (file.name.endsWith('.md') || file.name.endsWith('.txt'))) {
                const reader = new FileReader();
                reader.onload = (ev) => loadImportedContent(file.name, ev.target.result);
                reader.readAsText(file);
            }
        });

        // Paste import
        document.addEventListener('paste', (e) => {
            const text = e.clipboardData.getData('text');
            if (text && text.length > 200 && !document.activeElement.isContentEditable) {
                loadImportedContent('Pasted_' + new Date().toISOString().split('T')[0] + '.md', text);
            }
        });

        init();
    </script>
</body>

</html>